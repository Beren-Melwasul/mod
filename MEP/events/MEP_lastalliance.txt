#-----------------------------------------------------
# MEP : Last Alliance Events
#-----------------------------------------------------
# Global Flags:
# mep_start_lastalliance, mep_lastalliance_done1, mep_lastalliance_done2
# mep_lastalliance_offensive, mep_lastalliance_saurondefeated
# Character Flgas:
# mep_lastalliance_leader, mep_lastalliance_joined
#------------------------------------------------------------
# Events 0 to 8 : Setting up the alliance (with notifications)
# 

namespace = lastalliance
#------------------------------------------------------------
# Event 0: launched by Elendil (or the equivalent) via decision, present info and a choice to go ahead or not.
character_event = {
	id = lastalliance.0
	title = EVTTITlastalliance.0
	desc = EVTDESClastalliance.0
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# Send the requests to join
	option = {
		name = EVTOPTAlastalliance.0
		hidden_tooltip = {
			set_global_flag = mep_start_lastalliance
			set_variable = { which = mep_lastalliance_joined_counter value = 0 }
		}
		# The call is sent to 'good' independent rulers (except for ultra-isolationists )
		custom_tooltip = {
			text = TT_MEP_LASTALLIANCE0_SENDMESSAGE
			any_independent_ruler = {
				limit = {
					mep_is_good_side_trigger = yes
					NOT = { religion_group = religion_group_enyd }
					NOT = { culture = culture_valar }
					NOT = { culture = culture_enigma }
					higher_real_tier_than  = count
					mercenary = no
				}
				character_event = { id = lastalliance.1  days = 7 }
			}
		}
		wealth = -50
		# schedule event that will check the results of the messages
		hidden_tooltip = {
			character_event = { id = lastalliance.4  days = 30 }
		}
		
	}
	
	# I don't feel like that now...
	option = {
		trigger = { ai = no }
		name = EVTOPTBlastalliance.0
	}
	
}
#------------------------------------------------------------
# Event 1 : event sent to good side independent leaders to join last alliance or not.
character_event = {
	id = lastalliance.1
	title = EVTTITlastalliance.1
	desc = EVTDESClastalliance.1
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# yes, join
	option = {
		name = EVTOPTAlastalliance.1
		trigger = {
			is_alive = yes
			FROM = { is_alive = yes } 
		}
		# AI never joins if their opinion of the caller is less than -20
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				NOT = { opinion = { who = FROM value = -20 } }
			}
		}
		FROM = {
			character_event = { id = lastalliance.2 days = 7 }
		}

		
	}
	
	# no, don't join
	option = {
		name = EVTOPTBlastalliance.1
		trigger = {
			is_alive = yes
			FROM = { is_alive = yes } 
		}
		# AI always joins if their opinion of the caller is better than 30
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				opinion = { who = FROM value = 30 }
			}
		}
		FROM = {
			character_event = { id = lastalliance.3 days = 7 }
		}
	}
	
	# The caller has died while this message reached you
	option = {
		name = EVTOPTClastalliance.1
		trigger = {
			is_alive = yes
			FROM = { is_alive = no } 
		}
		# do nothing except clear the flag
		clr_global_flag = mep_start_lastalliance
	}
	
}
#------------------------------------------------------------
# Events 2 and 3 : Positive or negative response to Request
# Event 2 : Response, Yes, X will join!
character_event = {
	id = lastalliance.2
	title = EVTTITlastalliance.2
	desc = EVTDESClastalliance.2
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# good
	option = {
		name = EVTOPTAlastalliance.2
		trigger = { is_alive = yes } # not sure if this is necessary...
		# set up the alliance...
		FROM = {
			opinion = {
				modifier = in_non_aggression_pact
				who = ROOT
				years = 20 #Set duration
			}
			reverse_opinion = {
				modifier = in_non_aggression_pact
				who = ROOT
				years = 20 #Set duration
			}
			add_alliance = { who = ROOT years = 20 } #Set duration
			hidden_tooltip = {
				set_character_flag = mep_lastalliance_joined
			}
		}
		# perhaps add an extra opinion modifier here...
		# logging the response
		hidden_tooltip = {
			change_variable = { which = mep_lastalliance_joined_counter value = 1 }
		}
		
	}
	
	# just in case the proposer of the alliance dies...
	option = {
		name = EVTOPTBlastalliance.2
		trigger = { is_alive = no }
		# clear flags and stuff
		hidden_tooltip = {
			clr_global_flag = mep_start_lastalliance
		}
	}
	
}
#------------------------------------------------------------
# Event 3 : Response, NO, X will NOT join
character_event = {
	id = lastalliance.3
	title = EVTTITlastalliance.3
	desc = EVTDESClastalliance.3
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# Darn!
	option = {
		name = EVTOPTAlastalliance.3
		trigger = { is_alive = yes } # not sure if this is necessary...
		# perhaps add an extra opinion modifier here...
	}
	
	# just in case the propoer of the alliance dies...
	option = {
		name = EVTOPTBlastalliance.3
		trigger = { is_alive = no }
		# clear flags and stuff
		hidden_tooltip = {
			clr_global_flag = mep_start_lastalliance
		}
	}
}
#------------------------------------------------------------
# Event 4 : fires to check what the results of the requests are
character_event = {
	id = lastalliance.4
	hide_window = yes
	
	is_triggered_only = yes
	
	# calculating the effects
	immediate = {
		clr_global_flag = mep_start_lastalliance
		# you need Gil-Galad (or his successor) and 2 others for a successful alliance-forming
		if = {
			limit = {
				check_variable = { which = mep_lastalliance_joined_counter value = 3 }
				e_noldor = {
					has_holder = yes
					holder_scope = { has_character_flag = mep_lastalliance_joined }
				}
			}
			set_global_flag = mep_lastalliance_done1
		}
	}
	
	# Successful (and still alive)
	option = {
		trigger = {
			is_alive = yes
			has_global_flag = mep_lastalliance_done1
		} 
		character_event = { id = lastalliance.5 }
	}
	
	# Unsuccessful (and still alive)
	option = {
		trigger = {
			is_alive = yes
			NOT = { has_global_flag = mep_lastalliance_done1 }
		}
		# clear flags and stuff
		any_independent_ruler = {
			limit = { has_character_flag = mep_lastalliance_joined }
			clr_character_flag = mep_lastalliance_joined
			character_event = { id = lastalliance.7  days = 7 }
		}
		character_event = { id = lastalliance.6 }
	}
	
	# Dead
	option = {
		trigger = { is_alive = no }
		# clear flags and stuff
		hidden_tooltip = {
			clr_global_flag = mep_start_lastalliance
			any_independent_ruler = {
				limit = { has_character_flag = mep_lastalliance_joined }
				clr_character_flag = mep_lastalliance_joined
				character_event = { id = lastalliance.7  days = 7 }
			}
		}
	}
}

#------------------------------------------------------------
# Event 5, The 'Last Alliance' is go
character_event = {
	id = lastalliance.5
	title = EVTTITlastalliance.5
	desc = EVTDESClastalliance.5
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# Bring peace and prepare for war
	option = {
		name = EVTOPTAlastalliance.5
		# Making sure the alliance launcher (probably Elendil) and Gil-Galad/E-Noldor are still allive
		trigger = {
			is_alive = yes # not sure if this is necessary...
			e_noldor = {
				has_holder = yes
				holder_scope = {
					has_character_flag = mep_lastalliance_joined
				}
			}
		} 
		# eliminating wars among alliance members...
		custom_tooltip = {
			text = TT_MEP_LASTALLIANCE5_MAKEPEACE
			hidden_tooltip = {
				any_independent_ruler = {
					limit = { has_character_flag = mep_lastalliance_joined }
					any_independent_ruler = {
						limit = {
							has_character_flag = mep_lastalliance_joined
							NOR = {
								reverse_has_opinion_modifier = { who = PREV modifier = in_non_aggression_pact }
								has_opinion_modifier = { who = PREV modifier = in_non_aggression_pact }
							}
						}
						# we get here if the ruler has joined the alliance and does not have a non-aggression pact with PREV
						# enforcing peace if they are at war
						if = {  
							limit = { war_with = PREV }
							any_war = {
								limit = {
									OR = {
										any_attacker = { character = PREV }
										any_defender = { character = PREV }
									}
								}
								end_war = invalid
							}
						}
						# creating the non-aggression pact..
						opinion = {
							modifier = in_non_aggression_pact
							who = PREV
							years = 10 #Set duration
						}
						reverse_opinion = {
							modifier = in_non_aggression_pact
							who = PREV
							years = 10 #Set duration
						}
						# set_the_kings_peace = yes ??
					}
					character_event = { id = lastalliance.8 }
				}
			}
			
		}
		# final preps...
		hidden_tooltip = {
			clr_global_flag = mep_lastalliance_done1
			set_global_flag = mep_lastalliance_done2
			set_character_flag = mep_lastalliance_leader
		}
		

	}
	
	# just in case the propoer of the alliance, or gil-galad dies at just the wrong moment...
	option = {
		name = EVTOPTBlastalliance.5
		trigger = {
			OR = {
				is_alive = no
				e_noldor = {
					OR = {
						has_holder = no
						holder_scope = {
							NOT = { has_character_flag = mep_lastalliance_joined }
						}
					}
				}
			}
		}
		# clear flags
		hidden_tooltip = {
			clr_global_flag = mep_lastalliance_done1
			any_independent_ruler = {
				limit = { has_character_flag = mep_lastalliance_joined }
				clr_character_flag = mep_lastalliance_joined
				character_event = { id = lastalliance.7  days = 7 }
			}
		}
	}
	
}
#------------------------------------------------------------
# Event 6, The 'Last Alliance' has failed to happen
character_event = {
	id = lastalliance.6
	title = EVTTITlastalliance.6
	desc = EVTDESClastalliance.6
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# Your hopes have failed
	option = {
		name = EVTOPTAlastalliance.6
		hidden_tooltip = {
			add_character_modifier = { name = mep_lastalliance_failed  duration = 1825 }
		}
	}	
}
#------------------------------------------------------------
# Event 7 : Notification that the last alliance is aborted
character_event = {
	id = lastalliance.7
	title = EVTTITlastalliance.7
	desc = {
		trigger = { FROM = { is_alive = yes } }
		text = EVTDESClastalliance.7a
	}
	desc = {
		trigger = { FROM = { is_alive = no } }
		text = EVTDESClastalliance.7b
	}
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# Unfortunate
	option = {
		name = EVTOPTAlastalliance.7
	}
	
}
#------------------------------------------------------------
# Event 8 : Notification that the last alliance is go
character_event = {
	id = lastalliance.8
	title = EVTTITlastalliance.8
	desc = EVTDESClastalliance.8
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# Good
	option = {
		name = EVTOPTAlastalliance.8
	}
	
}
#------------------------------------------------------------
# an event is probably needed if the alliance leader dies, if e_noldor dies, or if sauron dies, before the war is started...
#======================================================================
# Event 10: launched by Elendil (or the equivalent) via decision, to start the anti-mordor war
character_event = {
	id = lastalliance.10
	title = EVTTITlastalliance.10
	desc = EVTDESClastalliance.10
	picture = GFX_evt_sauronreturns
	
	is_triggered_only = yes
	
	# Go ahead
	option = {
		name = EVTOPTAlastalliance.10
		e_barad_dur = {
			holder_scope = {
				reverse_war = {
					target = PREVPREV 
					casus_belli = kingdom_good_attack_evil
					thirdparty_title = k_mordor
				}
			}
		}
		hidden_tooltip = {
			add_global_flag = mep_lastalliance_offensive
			clr_global_flag = mep_lastalliance_done2
		}
		
	}
	
	# I don't feel like that now...
	option = {
		trigger = { ai = no }
		name = EVTOPTBlastalliance.10
	}
	
}

